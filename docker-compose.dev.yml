# Development docker-compose with local directory mounts for easy inspection
# Usage: docker compose -f docker-compose.dev.yml up
#
# All persistent data is stored in .dev-volumes/ directory:
#   .dev-volumes/vault/  - Knowledge vault storage
#   .dev-volumes/claude/ - Claude agent sessions
#   .dev-volumes/data/   - APNs device tokens and other data

services:
  primeai:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: primeai-dev
    ports:
      - "8000:8000"
    volumes:
      # Mount local directories from .dev-volumes/ for easy inspection
      - ./.dev-volumes/vault:/vault
      - ./.dev-volumes/claude:/home/prime/.claude
      - ./.dev-volumes/data:/data
      - ./config.yaml:/app/config.yaml:ro
      # Optional: mount source code for live development (uncomment if needed)
      # - ./app:/app/app:ro
    environment:
      # Configuration file location (required)
      - CONFIG_PATH=/app/config.yaml
      # Secrets (referenced in config.yaml as ${VAR_NAME})
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-}
      - AUTH_TOKEN=${AUTH_TOKEN}
      # Git secrets (optional, only needed if git.enabled=true in config.yaml)
      - GIT_SSH_KEY=${GIT_SSH_KEY:-}
      - GIT_USERNAME=${GIT_USERNAME:-}
      - GIT_TOKEN=${GIT_TOKEN:-}
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "bash",
          "-c",
          "cd /app && uv run python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/health')\"",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
